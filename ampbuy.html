
<!doctype html>
<html>
  <head>    
    <meta charset="utf-8">
    <title>Buy Personal MilesÂ®</title>
    <link rel="icon" href="https://d11cf5c0j6jffz.cloudfront.net/lps/mileage-plus/latest/images/favicon.ico"/>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <link rel="stylesheet" href="https://ampbyexample.com/css/ampstart.css">
    <style>
      body {
        margin: 0;
      }
      button {
        width: 130px;
        height: 42px;
      }
    </style>
  </head>
  <body>
    <button id="buy" class="ampstart-btn caps">Buy</button>
    <script>
(function (d, w) {
  var buyButton = d.getElementById('buy');
  if (!window.PaymentRequest) {
    buyButton.setAttribute('disabled', '');
    buyButton.text = 'Disabled';
    console.log('Payment request API not supported by this browser');
    return;
  }
  buyButton.onclick = function(event) {
    var productIdToDetails = {
      2000: {
        miles: 70,
        fees: 5.25
      },
      2000: {
        miles: 175,
        fees: 13.13,
        bonus: 1250
      }
    };

    var productId = getParameterByName('productId');
    var product = productIdToDetails[productId];

    console.log("Buying product " + product['name'] + ": "
      + productId);

    var supportedInstruments = [{
      supportedMethods: ['basic-card']
    }];

    var cost = product['miles']+product['fees'];
    
    var total = {
        label: 'TOTAL', 
        amount: {
          currency: 'USD', 
          value: cost.toFixed(2)
        }
      };
    var displayItems = [];
    
    displayItems.push({
      label: 'Cost of '+productId+' miles',
      amount: {currency: 'USD', value: product['miles'].toFixed(2)}
    });
    
    if (product['bonus']) {
      displayItems.push({
        label: product['bonus']+' bonus miles',
        amount: {currency: 'USD', value: 0.00}
      });
    }
    
    displayItems.push({
      label: 'Tax recovery fee',
      amount: {currency: 'USD', value: product['fees'].toFixed(2)}
    });

    var details = {
      total: total,
      displayItems: displayItems;
    };
    
    var options = {
      requestPayerName: true,
      requestShipping: false,
      shippingType: 'pickup'
    };

    if (window.PaymentRequest) {
      new PaymentRequest(supportedInstruments, details, options)
        .show()
        .then(function(instrumentResponse) {
          console.log('success');
          console.log(instrumentResponse.details.cardNumber+" "+instrumentResponse.details.cardSecurityCode);
          instrumentResponse.complete('success').then(function() {
            top.window.location.href = 'https://ampbyexample.com';
          });
        })
        .catch(function(err) {
          console.log(err);
        });
    }
  }

  function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
      results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
  }
})(document, window);
    </script>
  </body>
</html>
